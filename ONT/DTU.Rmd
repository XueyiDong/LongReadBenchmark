---
title: "DTU"
author: "Xueyi Dong"
date: "12/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(DRIMSeq)
library(DEXSeq)
library(limma)
library(edgeR)
library(satuRn)
library(SummarizedExperiment)
# library(IsoformSwitchAnalyzeR)
```

## Load salmon quantification

```{r}
# Load Salmon quant TPM data
samples <- paste0("barcode0", 1:6)
quant <- file.path("./salmon", samples, "quant.sf")
library(tximport)
txi <- tximport(quant, type="salmon", txOut=TRUE, countsFromAbundance = "scaledTPM")
library(GenomicFeatures)
gtf <- "/wehisan/home/allstaff/d/dong.x/annotation/HumanSequins/gencode.v33.sequins.gtf"
txdb <- makeTxDbFromGFF(gtf)
saveRDS(txdb, "txdb.RDS")
txdf <- select(txdb, keys(txdb, "GENEID"), "TXNAME", "GENEID") 
tab <- table(txdf$GENEID) 
txdf$ntx <- tab[match(txdf$GENEID, names(tab))]

```

## DRIMSeq

### human
```{r}
samples <- data.frame(
  sample_id = samples,
  group = rep(c("H1975", "HCC827"), c(3,3)),
  stringsAsFactors = FALSE
)
samples$group <- as.factor(samples$group)
counts <- as.data.frame(txi$counts, stringAsFactors = FALSE)
# deal with gene names
genes <- rownames(counts)
genes <- strsplit2(genes, "|", fixed=TRUE)
rownames(counts) <- genes[,1]
counts <- counts[match(txdf$TXNAME, rownames(counts)),]
counts <- cbind(txdf$GENEID, txdf$TXNAME, counts)
colnames(counts)[3:ncol(counts)] <- make.names(colnames(counts)[3:ncol(counts)])
colnames(counts) <- c("gene_id", "feature_id", samples$sample_id)

human.gene <- grep("^ENSG", counts$gene_id)
sequin.gene <- grep("^R", counts$gene_id)

# DRIMSeq analysis for human genes
d.human <- dmDSdata(counts = counts[human.gene,], samples = samples)
d.human <- dmFilter(d.human, min_samps_gene_expr = 6, min_samps_feature_expr = 3, 
              min_gene_expr = 10, min_feature_expr = 10, 
              min_samps_feature_prop = 3, min_feature_prop = 0.1,
              run_gene_twice = T)

design <- model.matrix(~group, data=DRIMSeq::samples(d.human))
colnames(design) <- sub("group", "", colnames(design))
# below not run
set.seed(1904)
register(MulticoreParam())
d.human <- dmPrecision(d.human, design, BPPARAM = BiocParallel::bpparam())
d.human <- dmFit(d.human, design = design, verbose=1, BPPARAM = BiocParallel::bpparam())
head(proportions(d.human))

d <- dmTest(d, coef = "HCC827")
head(DRIMSeq::results(d))
head(DRIMSeq::results(d, level = "feature"))

res <- DRIMSeq::results(d)
res.txp <- DRIMSeq::results(d, level = "feature")
```
### sequin

```{r}
d.sequin <- dmDSdata(counts = counts[sequin.gene,], samples = samples)
d.sequin <- dmFilter(d.sequin, min_samps_gene_expr = 6, min_samps_feature_expr = 3, 
              min_gene_expr = 10, min_feature_expr = 10, 
              min_samps_feature_prop = 3, min_feature_prop = 0.1,
              run_gene_twice = T)

design <- model.matrix(~group, data=DRIMSeq::samples(d.sequin))
colnames(design) <- sub("group", "", colnames(design))
# below not run
set.seed(1904)
register(MulticoreParam())
d.sequin <- dmPrecision(d.sequin, design, BPPARAM = BiocParallel::bpparam())
d.sequin <- dmFit(d.sequin, design = design, verbose=1, BPPARAM = BiocParallel::bpparam())
head(proportions(d.sequin))

d.sequin <- dmTest(d.sequin, coef = "HCC827")
head(DRIMSeq::results(d.sequin))
head(DRIMSeq::results(d.sequin, level = "feature"))

drres.sequin <- DRIMSeq::results(d.sequin)
drres.txp.sequin <- DRIMSeq::results(d.sequin, level = "feature")
```


## DEXSeq

### human

```{r}
# human, using DRIMSeq filtered results
dxd.human <- DEXSeqDataSet(countData = round(as.matrix(counts(d.human)[,-c(1:2)])),
                     sampleData=samples,
                     design=~sample+exon+group:exon,
                     featureID=counts(d.human)$feature_id,
                     groupID=counts(d.human)$gene_id)
dxd.human <- estimateSizeFactors(dxd.human)
dxd.human <- estimateDispersions(dxd.human)
dxd.human <- testForDEU(dxd.human, reducedModel = ~sample+exon)
dxr.human <- DEXSeqResults(dxd.human, independentFiltering = FALSE)
qval.human <- perGeneQValue(dxr.human)
# gene level result
dxr.g.human <- data.frame(gene=names(qval.human), qval.human)
# feature level
dxr.human <- as.data.frame(dxr.human[,c("featureID", "groupID", "pvalue", "padj")])
```

### sequin

```{r}
# sequin, using DRIMSeq filtered results
dxd.sequin <- DEXSeqDataSet(countData = round(as.matrix(counts(d.sequin)[,-c(1:2)])),
                     sampleData=samples,
                     design=~sample+exon+group:exon,
                     featureID=counts(d.sequin)$feature_id,
                     groupID=counts(d.sequin)$gene_id)
dxd.sequin <- estimateSizeFactors(dxd.sequin)
dxd.sequin <- estimateDispersions(dxd.sequin)
dxd.sequin <- testForDEU(dxd.sequin, reducedModel = ~sample+exon)
dxr.sequin <- DEXSeqResults(dxd.sequin, independentFiltering = FALSE)
qval.sequin <- perGeneQValue(dxr.sequin)
# gene level result
dxr.g.sequin <- data.frame(gene=names(qval.sequin), qval.sequin)
# feature level
dxr.sequin <- as.data.frame(dxr.sequin[,c("featureID", "groupID", "pvalue", "padj")])
```

## limma

### human

```{r}
# also using DRIMSeq filtered results
x.human <- DGEList(counts = as.matrix(counts(d.human)[,-c(1:2)]),
                   samples = samples)
rownames(x.human) <- counts(d.human)$feature_id
x.human <- calcNormFactors(x.human)
v.human <- voom(x.human, design, plot=T)
fit.human <- lmFit(v.human)
efit.human <- eBayes(fit.human)
ex.human <- diffSplice(efit.human, geneid = counts(d.human)$gene_id, exonid=counts(d.human)$feature_id)
ts.human <- topSplice(ex.human, number = Inf)
ts.human.tx <- topSplice(ex.human, test = "t", number = Inf)
```

### sequin

```{r}
# also using DRIMSeq filtered results
x.sequin <- DGEList(counts = as.matrix(counts(d.sequin)[,-c(1:2)]),
                   samples = samples)
rownames(x.sequin) <- counts(d.sequin)$feature_id
x.sequin <- calcNormFactors(x.sequin)
v.sequin <- voom(x.sequin, design, plot=T)
fit.sequin <- lmFit(v.sequin)
efit.sequin <- eBayes(fit.sequin)
ex.sequin <- diffSplice(efit.sequin, geneid = counts(d.sequin)$gene_id, exonid=counts(d.sequin)$feature_id)
ts.sequin <- topSplice(ex.sequin, number = Inf)
ts.sequin.tx <- topSplice(ex.sequin, test = "t", number = Inf)
```

## edgeR

### human

```{r}
x.human <- estimateDisp(x.human, design)
plotBCV(x.human)
qlfit.human <- glmQLFit(x.human, design)
plotQLDisp(qlfit.human)
sp.human <- diffSpliceDGE(qlfit.human, geneid = counts(d.human)$gene_id, exonid=counts(d.human)$feature_id)
tsdge.human <- topSpliceDGE(sp.human, test = "simes", number = Inf)
tsdge.human.tx <- topSpliceDGE(sp.human, test = "exon", number = Inf)
```
### sequin

```{r}
x.sequin <- estimateDisp(x.sequin, design)
plotBCV(x.sequin)
qlfit.sequin <- glmQLFit(x.sequin, design)
plotQLDisp(qlfit.sequin)
sp.sequin <- diffSpliceDGE(qlfit.sequin, geneid = counts(d.sequin)$gene_id, exonid=counts(d.sequin)$feature_id)
tsdge.sequin <- topSpliceDGE(sp.sequin, test = "simes", number = Inf)
tsdge.sequin.tx <- topSpliceDGE(sp.sequin, test = "exon", number = Inf)
```

## satuRn

### human

```{r}
counts.human <- counts(d.human)[,-c(1:2)]
rownames(counts.human) <- counts(d.human)$feature_id
sumExp.human <- SummarizedExperiment(
  assays = list(counts = counts.human),
  colData = samples,
  rowData = data.frame(
    gene_id = counts(d.human)$gene_id,
    isoform_id = counts(d.human)$feature_id
  )
)
metadata(sumExp.human)$formula <- ~ as.factor(colData(sumExp.human)$group)
sumExp.human <- fitDTU(object = sumExp.human,
                       formula=~0+group)
design2 <- model.matrix(~0+group, data=DRIMSeq::samples(d.human))
colnames(design2) <- sub("group", "", colnames(design2))
contr <- makeContrasts(BvsA=HCC827-H1975, levels=colnames(design2))
sumExp.human <- testDTU(object = sumExp.human, contrasts = contr)
head(rowData(sumExp.human)[["fitDTUResult_BvsA"]])

# Compute gene level q-values
pvals.human <- rowData(sumExp.human)[["fitDTUResult_BvsA"]]$pval
geneID <- factor(rowData(sumExp.human)$gene_id)
geneSplit <- split(seq(along = geneID), geneID)
pGene.human <- sapply(geneSplit, function(i) min(pvals.human[i]))
pGene.human[is.na(pGene.human)] <- 1
theta <- unique(sort(pGene.human))
# gene-level significance testing
q.human <- DEXSeq:::perGeneQValueExact(pGene.human, theta, geneSplit) 
qScreen.human <- rep(NA_real_, length(pGene.human))
qScreen.human <- q.human[match(pGene.human, theta)]
qScreen.human <- pmin(1, qScreen.human)
names(qScreen.human) <- names(geneSplit)
```

### sequin

```{r}
counts.sequin <- counts(d.sequin)[,-c(1:2)]
rownames(counts.sequin) <- counts(d.sequin)$feature_id
sumExp.sequin <- SummarizedExperiment(
  assays = list(counts = counts.sequin),
  colData = samples,
  rowData = data.frame(
    gene_id = counts(d.sequin)$gene_id,
    isoform_id = counts(d.sequin)$feature_id
  )
)
metadata(sumExp.sequin)$formula <- ~ as.factor(colData(sumExp.sequin)$group)
sumExp.sequin <- fitDTU(object = sumExp.sequin,  
                       formula=~0+group)
design2 <- model.matrix(~0+group, data=DRIMSeq::samples(d.sequin))
colnames(design2) <- sub("group", "", colnames(design2))
contr <- makeContrasts(BvsA=HCC827-H1975, levels=colnames(design2))
sumExp.sequin <- testDTU(object = sumExp.sequin, contrasts = contr)
head(rowData(sumExp.sequin)[["fitDTUResult_BvsA"]])

# Compute gene level q-values
pvals.sequin <- rowData(sumExp.sequin)[["fitDTUResult_BvsA"]]$pval
geneID <- factor(rowData(sumExp.sequin)$gene_id)
geneSplit <- split(seq(along = geneID), geneID)
pGene.sequin <- sapply(geneSplit, function(i) min(pvals.sequin[i]))
pGene.sequin[is.na(pGene.sequin)] <- 1
theta <- unique(sort(pGene.sequin))
# gene-level significance testing
q.sequin <- DEXSeq:::perGeneQValueExact(pGene.sequin, theta, geneSplit) 
qScreen.sequin <- rep(NA_real_, length(pGene.sequin))
qScreen.sequin <- q.sequin[match(pGene.sequin, theta)]
qScreen.sequin <- pmin(1, qScreen.sequin)
names(qScreen.sequin) <- names(geneSplit)
```

## Compare results

### sequin

```{r}
annodir <- "/wehisan/home/allstaff/d/dong.x/annotation/sequins"
anno <- read.delim(file.path(annodir, "rnasequin_isoforms_2.4.tsv"), sep = "\t", stringsAsFactors = FALSE)
geneanno <- read.delim(file.path(annodir, "rnasequin_genes_2.4.tsv"), sep = "\t", stringsAsFactors = FALSE)
# calculate annotate proportion
proportion <- data.frame(txID = anno$NAME)
tx2gene <- limma::strsplit2(proportion$txID, "_")
tx2gene <-  paste(tx2gene[,1], tx2gene[,2], sep="_")
proportion$geneID <- tx2gene
m <- match(proportion$geneID, geneanno$NAME)
proportion$MIX_A <- anno$MIX_A / geneanno$MIX_A[m]
proportion$MIX_B <- anno$MIX_B / geneanno$MIX_B[m]
proportion$FC <- proportion$MIX_A / proportion$MIX_B
proportion$isChanges <- FALSE
proportion$isChanges[abs(proportion$FC-1) > 0.001] <- TRUE
saveRDS(proportion, file="proportion.RDS")

trueDTU.gene <- unique(proportion$geneID[proportion$isChanges==TRUE])
trueDTU.transcript <- proportion$txID[proportion$isChanges==TRUE]
```

#### FDR and TPR

```{r}
# extract DTU genes
DTU.genes <- list(
  DRIMSeq = drres.sequin$gene_id[drres.sequin$adj_pvalue < 0.05],
  DEXSeq = dxr.g.sequin$gene[dxr.g.sequin$qval.sequin < 0.05],
  limma = ts.sequin$GeneID[ts.sequin$FDR < 0.05],
  edgeR = tsdge.sequin$GeneID[tsdge.sequin$FDR < 0.05],
  satuRn = names(qScreen.sequin)[qScreen.sequin < 0.05]
)

FDR.gene <-
  sapply(DTU.genes, function(x) {
    FD = sum(!(x %in% trueDTU.gene))
    FD / length(x)
  }, simplify = TRUE)

TPR.gene <-
  sapply(DTU.genes, function(x){
    TP = sum(x %in% trueDTU.gene)
    TP / sum(trueDTU.gene %in% counts(d.sequin)$gene_id)
  }, simplify=TRUE)

```

```{r}
DTU.transcripts <- list(
  DRIMSeq = drres.txp.sequin$feature_id[drres.txp.sequin$adj_pvalue < 0.05],
  DEXSeq = dxr.sequin$featureID[dxr.sequin$padj < 0.05],
  limma = ts.sequin.tx$ExonID[ts.sequin.tx$FDR < 0.05],
  edgeR = tsdge.sequin.tx$ExonID[tsdge.sequin.tx$FDR < 0.05],
  satuRn = rownames(rowData(sumExp.sequin)[["fitDTUResult_BvsA"]])[rowData(sumExp.sequin)[["fitDTUResult_BvsA"]]$regular_FDR < 0.05]
)

FDR.transcripts <-
  sapply(DTU.transcripts, function(x) {
    FD = sum(!(x %in% trueDTU.transcript))
    FD / length(x)
  }, simplify = TRUE)

TPR.transcripts <-
  sapply(DTU.transcripts, function(x){
    TP = sum(x %in% trueDTU.transcript)
    TP / sum(trueDTU.transcript %in% counts(d.sequin)$feature_id)
  }, simplify=TRUE)

```

```{r}
DTU.res <-data.frame(
  FDR = c(FDR.gene, FDR.transcripts),
  TPR = c(TPR.gene, TPR.transcripts),
  Method = c(names(FDR.gene), names(FDR.transcripts)),
  Test_level = rep(c("gene level", "transcript level"), c(length(FDR.gene), length(FDR.transcripts)))
)
pdf("DTUres/sequinFDRTPR.pdf", height = 4)
ggplot(DTU.res, aes(x=FDR, y=TPR, colour=Method, shape=Test_level)) +
  # geom_point(size = 5) +
  geom_jitter(size = 5) +
  # scale_shape_manual(values=c(3,4)) +
  theme_bw()
dev.off()
```
#### Overlap of DTU genes

```{r}
library(UpSetR)
pdf("DTUres/sequinUpset.pdf", height = 4)
upset(fromList(DTU.genes), order.by = "freq")
upset(fromList(DTU.transcripts), order.by = "freq")
dev.off()
```

### Human

#### overlap of DTU genes

```{r}
# extract DTU genes
DTU.genes.human <- list(
  # DRIMSeq = drres.human$gene_id[drres.human$adj_pvalue < 0.05],
  DEXSeq = dxr.g.human$gene[dxr.g.human$qval.human < 0.05],
  limma = ts.human$GeneID[ts.human$FDR < 0.05],
  edgeR = tsdge.human$GeneID[tsdge.human$FDR < 0.05],
  satuRn = names(qScreen.human)[qScreen.human < 0.05]
)


upset(fromList(DTU.genes.human), order.by = "freq")
```

```{r}
DTU.transcripts.human <- list(
  # DRIMSeq = drres.txp.human$feature_id[drres.txp.human$adj_pvalue < 0.05],
  DEXSeq = dxr.human$featureID[dxr.human$pvalue < 0.05],
  limma = ts.human.tx$ExonID[ts.human.tx$FDR < 0.05],
  edgeR = tsdge.human.tx$ExonID[tsdge.human.tx$FDR < 0.05],
  satuRn = rownames(rowData(sumExp.human)[["fitDTUResult_BvsA"]])[rowData(sumExp.human)[["fitDTUResult_BvsA"]]$regular_FDR < 0.05]
)

upset(fromList(DTU.transcripts.human), order.by = "freq")
```

